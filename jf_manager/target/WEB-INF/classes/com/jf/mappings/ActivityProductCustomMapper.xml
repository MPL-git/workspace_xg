<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jf.dao.ActivityProductCustomMapper" >
  <resultMap id="BaseResultCustomMap" type="com.jf.entity.ActivityProductCustom" extends="com.jf.dao.ActivityProductMapper.BaseResultMap">
	<result column="product_name" property="productName" jdbcType="VARCHAR"/>
	<result column="product_code" property="productCode" jdbcType="VARCHAR"/>
	<result column="product_art_no" property="productArtNo" jdbcType="VARCHAR"/>
	<result column="product_audit_status" property="productAuditStatus" jdbcType="VARCHAR"/>
	<result column="product_pic" property="productPic" jdbcType="VARCHAR"/>
	 <result column="coo_audit_status_desc" property="cooAuditStatusDesc" jdbcType="VARCHAR" />
	 <result column="design_audit_status_desc" property="designAuditStatusDesc" jdbcType="VARCHAR" />
	 <result column="law_audit_status_desc" property="lawAuditStatusDesc" jdbcType="VARCHAR" />
	 <result column="operate_audit_status_desc" property="operateAuditStatusDesc" jdbcType="VARCHAR" />
	 <result column="refuse_flag_desc" property="refuseFlagDesc" jdbcType="VARCHAR" />
	 <result column="product_update_date" property="productUpdateDate" jdbcType="TIMESTAMP"/>
	 <result column="activity_sale_price" property="activitySalePrice" jdbcType="DECIMAL" />
	 <result column="minimum_price" property="minimumPrice" jdbcType="DECIMAL" />
	 <result column="tag_price" property="tagPrice" jdbcType="DECIMAL" />
	 <result column="dfg_price" property="dfgPrice" jdbcType="DECIMAL" />
	 <result column="join_num" property="joinNum" jdbcType="INTEGER"/>
	 <result column="product_stock" property="productStock" jdbcType="INTEGER"/>
	 <result column="product_type_name" property="productTypeName" jdbcType="VARCHAR"/>
	 <result column="product_brand_name" property="productBrandName" jdbcType="VARCHAR"/>
	 <result column="short_name" property="shortName" jdbcType="VARCHAR"/>
	 <result column="mcht_code" property="mchtCode" jdbcType="VARCHAR"/>
	 <result column="activity_name" property="activityName" jdbcType="VARCHAR"/>
	 <result column="activity_area_type_desc" property="activityAreaTypeDesc" jdbcType="VARCHAR"/>
	 <result column="activity_area_name" property="activityAreaName" jdbcType="VARCHAR"/>
	 <result column="submit_time" property="submitTime" jdbcType="TIMESTAMP"/>
	 <result column="activity_update_date" property="activityUpdateDate" jdbcType="TIMESTAMP"/>
	 <result column="contact_name" property="contactName" jdbcType="VARCHAR"/>
	 <result column="qq" property="qq" jdbcType="VARCHAR"/>
	 <result column="enroll_begin_time" property="enrollBeginTime" jdbcType="TIMESTAMP"/>
	 <result column="enroll_end_time" property="enrollEndTime" jdbcType="TIMESTAMP"/>
	 <result column="activity_begin_time" property="activityBeginTime" jdbcType="TIMESTAMP"/>
	 <result column="activity_end_time" property="activityEndTime" jdbcType="TIMESTAMP"/>
	 <result column="cmcht_ooperate_begin_date" property="mchtOoperateBeginDate" jdbcType="TIMESTAMP"/>
	 <result column="activity_area_pic" property="activityAreaPic" jdbcType="VARCHAR"/>
	 <result column="signle_type_two_num" property="signleTypeTwoNum" jdbcType="INTEGER"/>
	 <result column="this_sales_num" property="thisSalesNum" jdbcType="INTEGER"/>
	 <result column="total_sales_num" property="totalSalesNum" jdbcType="INTEGER"/>
	 <result column="dfg_num" property="dfgNum" jdbcType="INTEGER"/>
	 <result column="join_sale_num" property="joinSaleNum" jdbcType="INTEGER"/>
	 <result column="join_dfg_sale_num" property="joinDfgSaleNum" jdbcType="INTEGER"/>
	 <result column="sign_up_product_num" property="signUpProductNum" jdbcType="INTEGER"/>
	 <result column="mcht_sign_num" property="mchtSignNum" jdbcType="INTEGER"/>
	 <result column="this_product_quantity_num" property="thisProductQuantityNum" jdbcType="INTEGER"/>
	 <result column="this_product_appeal_num" property="thisProductAppealNum" jdbcType="INTEGER"/>
	 <result column="this_mcht_violate_num" property="thisMchtViolateNum" jdbcType="INTEGER"/>
	 <result column="sale_price_min" property="salePriceMin" jdbcType="INTEGER"/>
	 <result column="sale_price_Max" property="salePriceMax" jdbcType="INTEGER"/>
	 <result column="mall_price_min" property="mallPriceMin" jdbcType="INTEGER"/>
	 <result column="mall_price_max" property="mallPriceMax" jdbcType="INTEGER"/>
	 <result column="pop_commission_rate" property="popCommissionRate" jdbcType="DECIMAL"/>
	 <result column="discount_min" property="discountMin" jdbcType="DECIMAL"/>
	 <result column="discount_max" property="discountMax" jdbcType="DECIMAL"/>
	 <result column="each_day" property="eachDay" jdbcType="VARCHAR" />     
	 <result column="shop_data" property="shopdata" jdbcType="INTEGER" />
     <result column="examine_data" property="examinedata" jdbcType="INTEGER" />
     <result column="sale_data" property="saledata" jdbcType="INTEGER" />
     <result column="singleproduct_data" property="singleproductdata" jdbcType="INTEGER" />
     <result column="sale_price" property="salePrice" jdbcType="INTEGER" />
       
  </resultMap>
  <resultMap id="BaseResultMap" type="com.jf.entity.ActivityProduct" >
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="activity_id" property="activityId" jdbcType="INTEGER" />
    <result column="product_id" property="productId" jdbcType="INTEGER" />
    <result column="activity_price" property="activityPrice" jdbcType="DECIMAL" />
    <result column="refuse_flag" property="refuseFlag" jdbcType="CHAR" />
    <result column="operate_audit_by" property="operateAuditBy" jdbcType="INTEGER" />
    <result column="operate_audit_status" property="operateAuditStatus" jdbcType="CHAR" />
    <result column="design_audit_by" property="designAuditBy" jdbcType="INTEGER" />
    <result column="design_audit_status" property="designAuditStatus" jdbcType="CHAR" />
    <result column="law_audit_by" property="lawAuditBy" jdbcType="INTEGER" />
    <result column="law_audit_status" property="lawAuditStatus" jdbcType="CHAR" />
    <result column="coo_audit_by" property="cooAuditBy" jdbcType="INTEGER" />
    <result column="coo_audit_status" property="cooAuditStatus" jdbcType="CHAR" />
    <result column="create_by" property="createBy" jdbcType="INTEGER" />
    <result column="create_date" property="createDate" jdbcType="TIMESTAMP" />
    <result column="update_by" property="updateBy" jdbcType="INTEGER" />
    <result column="update_date" property="updateDate" jdbcType="TIMESTAMP" />
    <result column="remarks" property="remarks" jdbcType="VARCHAR" />
    <result column="del_flag" property="delFlag" jdbcType="CHAR" />
   
  </resultMap>
  <sql id="Base_Column_List" >
    id, activity_id, product_id, activity_price, refuse_flag, operate_audit_by, operate_audit_status, 
    design_audit_by, design_audit_status, law_audit_by, law_audit_status, coo_audit_by, 
    coo_audit_status, seq_no, is_watermark, is_gift, create_by, create_date, update_by, 
    update_date, remarks, del_flag
  </sql>
  <sql id="Example_Where_Clause" >
    <where >
      <foreach collection="oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause" >
    <where >
      <foreach collection="example.oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List_custom" >
    id, activity_id, product_id, activity_price, refuse_flag, operate_audit_by, operate_audit_status, 
    design_audit_by, design_audit_status, law_audit_by, law_audit_status, coo_audit_by, 
    coo_audit_status, seq_no, is_watermark, is_gift, create_by, create_date, update_by, 
    update_date, remarks, del_flag,
    (select p.name from bu_product p where p.id=ap.product_id) product_name,
    (select p.code from bu_product p where p.id=ap.product_id) product_code,
    (select p.art_no from bu_product p where p.id=ap.product_id) product_art_no,
    (select p.audit_status from bu_product p where p.id=ap.product_id) product_audit_status,
    (select pp.pic from bu_product_pic pp where pp.product_id=ap.product_id and pp.del_flag='0' and pp.is_default=1) product_pic,
    FUN_GET_STATUS_DESC("BU_ACTIVITY_PRODUCT","COO_AUDIT_STATUS", ap.coo_audit_status) coo_audit_status_desc,
    FUN_GET_STATUS_DESC("BU_ACTIVITY_PRODUCT","DESIGN_AUDIT_STATUS", ap.design_audit_status) design_audit_status_desc,
    FUN_GET_STATUS_DESC("BU_ACTIVITY_PRODUCT","LAW_AUDIT_STATUS", ap.law_audit_status) law_audit_status_desc,
    FUN_GET_STATUS_DESC("BU_ACTIVITY_PRODUCT","OPERATE_AUDIT_STATUS", ap.operate_audit_status) operate_audit_status_desc,
    FUN_GET_STATUS_DESC("BU_ACTIVITY_PRODUCT","REFUSE_FLAG", ap.refuse_flag) refuse_flag_desc,
    (select p.update_date from bu_product p where p.id=ap.product_id) product_update_date,
    (select MIN(pi.sale_price) from bu_product_item pi where pi.product_id=ap.product_id and pi.del_flag='0') activity_sale_price,
    (select IFNULL(count(apt.id),0) from bu_activity_product apt where apt.product_id=ap.product_id and apt.del_flag='0') joinNum,
    (select IFNULL(SUM(bpi.stock-bpi.locked_amount),0) from bu_product_item bpi where bpi.del_flag='0' and bpi.product_id=ap.product_id) product_stock,
    (SELECT bpt.name FROM bu_product_type bpt WHERE bpt.id=(SELECT ba.product_type_id FROM bu_activity ba WHERE ba.id=ap.activity_id)) product_type_name,
    (SELECT pb.name FROM bu_product_brand pb WHERE pb.id=(SELECT ba.brand_id FROM bu_product ba WHERE ba.id=ap.product_id)) product_brand_name,
    (SELECT m.short_name FROM bu_mcht_info m WHERE m.id=(SELECT ba.mcht_id FROM bu_activity ba WHERE ba.id=ap.activity_id)) short_name,
    (SELECT m.mcht_code FROM bu_mcht_info m WHERE m.id=(SELECT ba.mcht_id FROM bu_activity ba WHERE ba.id=ap.activity_id)) mcht_code,
    (SELECT m.create_date FROM bu_mcht_info m WHERE m.id=(SELECT ba.mcht_id FROM bu_activity ba WHERE ba.id=ap.activity_id)) cmcht_ooperate_begin_date,
    (select b.name from bu_activity b where b.id=ap.activity_id) activity_name,
    FUN_GET_STATUS_DESC("BU_ACTIVITY_AREA","TYPE", (SELECT baa.type FROM bu_activity_area baa WHERE baa.id=(SELECT ay.activity_area_id FROM bu_activity ay WHERE ay.id=ap.activity_id))) activity_area_type_desc,
    (SELECT baa.name FROM bu_activity_area baa WHERE baa.id=(SELECT ay.activity_area_id FROM bu_activity ay WHERE ay.id=ap.activity_id)) activity_area_name,
    (SELECT baa.enroll_begin_time FROM bu_activity_area baa WHERE baa.id=(SELECT ay.activity_area_id FROM bu_activity ay WHERE ay.id=ap.activity_id)) enroll_begin_time,
    (SELECT baa.enroll_end_time FROM bu_activity_area baa WHERE baa.id=(SELECT ay.activity_area_id FROM bu_activity ay WHERE ay.id=ap.activity_id)) enroll_end_time,
    (SELECT baa.activity_begin_time FROM bu_activity_area baa WHERE baa.id=(SELECT ay.activity_area_id FROM bu_activity ay WHERE ay.id=ap.activity_id)) activity_begin_time,
    (SELECT baa.activity_end_time FROM bu_activity_area baa WHERE baa.id=(SELECT ay.activity_area_id FROM bu_activity ay WHERE ay.id=ap.activity_id)) activity_end_time,
    (SELECT baa.pic FROM bu_activity_area baa WHERE baa.id=(SELECT ay.activity_area_id FROM bu_activity ay WHERE ay.id=ap.activity_id)) activity_area_pic,
  	(select b.submit_time from bu_activity b where b.id=ap.activity_id) submit_time,
  	(select b.update_date from bu_activity b where b.id=ap.activity_id) activity_update_date,
  	(SELECT cc.contact_name FROM bu_product aa,bu_mcht_platform_contact bb,bu_platform_contact cc WHERE aa.id = ap.product_id AND aa.mcht_id = bb.mcht_id AND bb.del_flag = '0' AND bb.platform_contact_id = cc.id AND cc.contact_type = '2' AND cc.del_flag = '0' AND aa.id=ap.product_id limit 1) contact_name,
  	(SELECT pc.qq FROM bu_activity baa, bu_mcht_platform_contact mpc, bu_platform_contact pc WHERE baa.id=ap.activity_id and baa.del_flag='0' and mpc.mcht_id=baa.mcht_id and mpc.del_flag='0' AND mpc.status = '1' AND mpc.del_flag = '0' and pc.id=mpc.platform_contact_id and pc.contact_type = '2' AND pc.status = '0' AND pc.del_flag = '0') qq,
	(SELECT IFNULL(COUNT(aa.id),0) FROM bu_activity_product aa,bu_activity bb,bu_activity_area cc WHERE bb.activity_area_id = cc.id and bb.status in ('5','6') AND cc.type in ('6','7') AND aa.activity_id = bb.id AND aa.product_id = ap.product_id and aa.del_flag='0' and aa.refuse_flag='0') signle_type_two_num,
	(SELECT	IFNULL(SUM(aa.quantity), 0) FROM bu_order_dtl aa WHERE aa.activity_id = ap.activity_id AND aa.product_status = 1 AND aa.product_id = ap.product_id) this_sales_num,
	(SELECT	IFNULL(SUM(aa.quantity), 0) FROM bu_order_dtl aa WHERE aa.product_status = '1' AND aa.product_id = ap.product_id) total_sales_num,
	(SELECT MIN(aa.sale_price) FROM bu_order_dtl aa,bu_product_item bb WHERE bb.product_id=ap.product_id AND bb.del_flag='0' and aa.product_item_id=bb.id) minimum_price,
	(SELECT MAX(aa.tag_price) FROM bu_product_item aa WHERE aa.del_flag='0' and aa.product_id=ap.product_id) tag_price,
	(SELECT IFNULL(SUM(od.quantity),0) FROM bu_order_dtl od where od.create_date &gt;= DATE_SUB(CURDATE(), INTERVAL 30 DAY) AND od.product_id=ap.product_id AND od.product_status=1 and od.del_flag='0') dfg_num,
	(SELECT IFNULL(SUM(od.sale_price*od.quantity),0.00) FROM bu_order_dtl od where od.create_date &gt;= DATE_SUB(CURDATE(), INTERVAL 30 DAY) AND od.product_id=ap.product_id AND od.product_status='1' and od.del_flag='0') dfg_price,
	(SELECT IFNULL(COUNT(bb.id), 0) FROM bu_activity bb, bu_activity_area cc WHERE bb.mcht_id = (select dd.mcht_id from bu_activity dd where dd.id=ap.activity_id) AND cc.id = bb.activity_area_id AND bb.STATUS IN ('5', '6') AND cc.type IN ('6', '7') and bb.del_flag='0') join_sale_num,
	(SELECT IFNULL(COUNT(bb.id), 0) FROM bu_activity bb, bu_activity_area cc WHERE bb.mcht_id = (select dd.mcht_id from bu_activity dd where dd.id=ap.activity_id) AND cc.id = bb.activity_area_id AND bb.STATUS IN ('5', '6') AND cc.type IN ('6', '7') and bb.del_flag='0' AND bb.create_date &gt;= DATE_SUB(CURDATE(), INTERVAL 30 DAY)) join_dfg_sale_num,
	(SELECT IFNULL(COUNT(aa.id),0) FROM bu_activity_product aa,bu_activity bb,bu_activity_area cc,bu_product dd WHERE dd.mcht_id=bb.mcht_id AND bb.activity_area_id=cc.id AND cc.type in ('6','7') AND bb.id=aa.activity_id AND dd.id=ap.product_id) sign_up_product_num,
	(SELECT IFNULL(COUNT(bb.id),0) FROM bu_activity bb,bu_activity_area cc,bu_product dd WHERE bb.activity_area_id=cc.id AND dd.mcht_id=bb.mcht_id AND cc.type in ('6','7')  AND dd.id=ap.product_id and bb.del_flag='0' and bb.status in ('5','6')) mcht_sign_num,
	(SELECT IFNULL(COUNT(od.quantity), 0) FROM bu_order_dtl od, bu_activity ba where od.activity_area_id =ba.activity_area_id and ba.id =ap.activity_id) AS this_product_quantity_num,
	(SELECT IFNULL(COUNT(aa.quantity),0) FROM bu_order_dtl aa,bu_activity bb,bu_activity_area cc,bu_activity_product dd WHERE bb.activity_area_id=cc.id AND aa.activity_area_id=cc.id AND aa.activity_id=bb.id AND bb.id=dd.activity_id AND dd.id=ap.product_id) this_product_quantity_num,
	(SELECT IFNULL(COUNT(cc.id ),0) from bu_order_dtl bb,bu_appeal_order cc where bb.product_id=ap.product_id and bb.del_flag='0' and bb.id=cc.order_dtl_id and cc.del_flag='0') this_product_appeal_num,
	(SELECT IFNULL(COUNT(bb.id ),0) FROM bu_violate_order bb WHERE bb.mcht_id=(SELECT ba.mcht_id FROM bu_activity ba WHERE ba.id=ap.activity_id) and bb.del_flag='0') this_mcht_violate_num,
	(select min(a.sale_price) from bu_product_item a where a.product_id=ap.product_id and a.del_flag='0') sale_price_min,
	(select max(a.sale_price) from bu_product_item a where a.product_id=ap.product_id and a.del_flag='0') sale_price_max,
	(select pk.pop_commission_rate from bu_mcht_product_brand pk where pk.mcht_id=(SELECT ba.mcht_id FROM bu_activity ba WHERE ba.id=ap.activity_id) and pk.product_brand_id=(SELECT ba.brand_id FROM bu_product ba WHERE ba.id=ap.product_id) and pk.status='1' and pk.del_flag='0') pop_commission_rate,
	 (select ROUND(min(pm.sale_price/pm.tag_price)*10,2) from bu_product_item pm where pm.product_id=ap.product_id and pm.del_flag='0') discount_min,
	(select ROUND(max(pm.sale_price/pm.tag_price)*10,2) from bu_product_item pm where pm.product_id=ap.product_id and pm.del_flag='0') discount_max
  </sql>
  <select id="selectByCustomExample" resultMap="BaseResultCustomMap" parameterType="com.jf.entity.ActivityProductCustomExample" >
    select
    <if test="distinct" >
      distinct
    </if>
    <include refid="Base_Column_List_custom" />
    from bu_activity_product ap
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null" >
      order by ${orderByClause}
    </if>
    <if test="limitStart != null and limitStart>=0" >
      limit #{limitStart} , #{limitSize}
    </if>
  </select>
  <select id="countByCustomExample" parameterType="com.jf.entity.ActivityProductCustomExample" resultType="java.lang.Integer" >
    select count(*) from bu_activity_product ap
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <select id="getStaffId" parameterType="Integer" resultType="Integer">
  	SELECT
		pc.staff_id
	FROM
		bu_platform_contact pc
	WHERE
		pc.id IN (
			SELECT
				mpc.platform_contact_id
			FROM
				bu_mcht_platform_contact mpc
			WHERE
				mpc.mcht_id = (
					SELECT
						bp.mcht_id
					FROM
						bu_product bp
					WHERE
						bp.id = #{productId}
				)
			AND mpc. STATUS = '1'
			AND mpc.del_flag = '0'
		)
	AND pc.contact_type = '2'
	AND pc. STATUS = '0'
	AND pc.del_flag = '0'
	limit 1
  </select>
  
    <select id="getStaffIdByActivity" parameterType="Integer" resultType="Integer">
  	SELECT
		pc.staff_id
	FROM
		bu_platform_contact pc
	WHERE
		pc.id IN (
			SELECT
				mpc.platform_contact_id
			FROM
				bu_mcht_platform_contact mpc
			WHERE
				mpc.mcht_id = (
					SELECT
						bp.mcht_id
					FROM
						bu_activity bp
					WHERE
						bp.id = #{activityId}
				)
			AND mpc. STATUS = '1'
			AND mpc.del_flag = '0'
		)
	AND pc.contact_type = '2'
	AND pc. STATUS = '0'
	AND pc.del_flag = '0'
	limit 1
  </select>
  
  <!-- 获得活动下的商品列表 -->
  <select id="getActivityIdByProductList" resultMap="BaseResultCustomMap" parameterType="map" >
    select
    <include refid="Base_Column_List_custom" />
    from bu_activity_product ap where ap.activity_id=#{activityId}
    <if test="productName!=null">
    	and ((select p.name from bu_product p where p.id=ap.product_id)  like concat('%',#{productName},'%') 
    	or 
    	(select p.code from bu_product p where p.id=ap.product_id) like concat('%',#{productName},'%') 
    	or
    	(select p.art_no from bu_product p where p.id=ap.product_id) like concat('%',#{productName},'%'))
    </if>
    <if test="type==1 or type==2">
    	and ap.operate_audit_by=#{staffId}
    </if>
    <if test="type==3">
    	and ap.design_audit_by=#{staffId} 
    </if>
    <if test="type==4">
    	and ap.law_audit_by=#{staffId}
    </if>
    <if test="type==5">
    	and ap.coo_audit_by=#{staffId}
    </if>
    and ap.refuse_flag=#{refuseFlag} order by ap.create_date desc
  </select>
  <!-- 获得活动下的商品列表总条数 -->
  <select id="getActivityIdByProductCount" resultType="Integer" parameterType="map" >
    select count(ap.id) from bu_activity_product ap where ap.activity_id=#{activityId} 
    <if test="productName!=null">
    	and ((select p.name from bu_product p where p.id=ap.product_id)  like concat('%',#{productName},'%') 
    	or 
    	(select p.code from bu_product p where p.id=ap.product_id) like concat('%',#{productName},'%') 
    	or
    	(select p.art_no from bu_product p where p.id=ap.product_id) like concat('%',#{productName},'%'))
    </if>
    <if test="type==1 or type==2">
    	and ap.operate_audit_by=#{staffId}
    </if>
    <if test="type==3">
    	and ap.design_audit_by=#{staffId} 
    </if>
    <if test="type==4">
    	and ap.law_audit_by=#{staffId}
    </if>
    <if test="type==5">
    	and ap.coo_audit_by=#{staffId}
    </if>
    and ap.refuse_flag=#{refuseFlag} order by ap.create_date desc
  </select>
<!--   获取活动商品详情 -->
  <select id="selectByActivityProductInfo" resultMap="BaseResultCustomMap" parameterType="Integer" >
    select 
    <include refid="Base_Column_List_custom" />
    from bu_activity_product ap
    where ap.id = #{activityProductId}
  </select>
  
  <select id="getActivityProductList" resultMap="BaseResultMap" parameterType="Integer">
  	select 
  	<include refid="Base_Column_List" />
    from bu_activity_product ap
    where ap.activity_id=#{activityId} and ap.del_flag=0 and ap.refuse_flag=0
  </select>
<!--  	设置更新运营专员审核商品通过 -->
  <select id="updateOperateAuditAdopt" parameterType="map">
  	UPDATE bu_activity_product ap SET ap.operate_audit_status='2',ap.design_audit_status='1',ap.operate_audit_by=#{staffId},ap.update_date=NOW(),ap.update_by=#{staffId} WHERE ap.activity_id=#{activityId} AND (ap.operate_audit_status is NULL or ap.operate_audit_status !=3) AND ap.del_flag=0
  </select>
<!--   设置更新设计专员审核商品通过 -->
  <select id="updateDesignAuditAdopt" parameterType="map">
  	UPDATE bu_activity_product ap SET ap.design_audit_status='2',ap.law_audit_status='1',ap.design_audit_by=#{staffId},ap.update_date=NOW(),ap.update_by=#{staffId} WHERE ap.activity_id=#{activityId} AND (ap.design_audit_status is NULL or ap.design_audit_status !=3) AND ap.del_flag=0
  </select>
<!--   设置更新法务专员审核商品通过 -->
  <select id="updateLawAuditAdopt" parameterType="map">
  	UPDATE bu_activity_product ap SET ap.law_audit_status='2',ap.coo_audit_status='1',ap.law_audit_by=#{staffId},ap.update_date=NOW(),ap.update_by=#{staffId} WHERE ap.activity_id=#{activityId} AND (ap.law_audit_status is NULL or ap.law_audit_status !=3) AND ap.del_flag=0
  </select>
<!--   设置更新运营总监专员审核商品通过 -->
  <select id="updateCooAuditAdopt" parameterType="map">
  	UPDATE bu_activity_product ap SET ap.coo_audit_status='2',ap.coo_audit_by=#{staffId},ap.update_date=NOW(),ap.update_by=#{staffId} WHERE ap.activity_id=#{activityId} AND (ap.coo_audit_status is NULL or ap.coo_audit_status !=3) AND ap.del_flag=0
  </select>
  
  <select id="getProductsByActivityAreaId" parameterType="int" resultMap="BaseResultCustomMap">
	SELECT
		ap.id,
		ap.seq_no,
		(select p.`name` from bu_product p WHERE p.id = ap.product_id AND p.del_flag='0')product_name,
		(SELECT MIN(pi.tag_price) FROM bu_product_item pi WHERE pi.product_id = ap.product_id AND pi.del_flag='0')tag_price_min,
		(SELECT MIN(pi.sale_price) FROM bu_product_item pi WHERE pi.product_id = ap.product_id AND pi.del_flag='0')sale_price_min,
		(SELECT MAX(pi.sale_price) FROM bu_product_item pi WHERE pi.product_id = ap.product_id AND pi.del_flag='0')sale_price_Max,
		(SELECT pp.pic from bu_product_pic pp WHERE pp.product_id = ap.product_id AND pp.is_default='1' AND pp.del_flag='0' LIMIT 1)product_pic,
		(SELECT IFNULL(SUM(bpi.stock-bpi.locked_amount),0) from bu_product_item bpi where bpi.del_flag='0' and bpi.product_id=ap.product_id) product_stock,
		(SELECT IFNULL(SUM(od.quantity),0) FROM bu_order_dtl od WHERE od.product_id = ap.product_id AND od.product_status='1' AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <![CDATA[ <= ]]> od.create_date AND od.del_flag='0')dfg_num,
		(SELECT IFNULL(SUM(od.sale_price*od.quantity),0.00) FROM bu_order_dtl od WHERE od.product_id = ap.product_id AND od.product_status='1' AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <![CDATA[ <= ]]> od.create_date AND od.del_flag='0')dfg_price
	FROM
		bu_activity_area aa,
		bu_activity a,
		bu_activity_product ap,
		bu_product_item b
	WHERE
		aa.id = a.activity_area_id AND
		a.id = ap.activity_id AND
		ap.product_id = b.product_id AND 
		aa.id = #{activityAreaId} AND
		a.status = '6' AND 
		ap.refuse_flag = '0' AND
		ap.coo_audit_status = '2' AND
		ap.del_flag = '0' AND 
		b.del_flag='0'
	GROUP BY ap.id
	ORDER BY IFNULL(ap.seq_no,99999),b.sale_price asc,b.tag_price desc
  </select>
  
  <select id="saveSort" resultType="java.lang.Integer" parameterType="java.util.HashMap">
  	select FUN_UPDATE_ACTIVITY_PRODUCT_SEQ_NO(#{data},#{staffID}) from dual;
  </select>
  
  

   <!-- <sql id="selectshopcustom">
  
  SELECT t.each_day,SUM(shop_data) shop_data,SUM(examine_data) examine_data,SUM(sale_data)sale_data,SUM(singleproduct_data) singleproduct_data FROM (
SELECT DATE_FORMAT(S.create_date,'%Y-%m-%d') AS each_day,COUNT(*) AS shop_data, 0 AS examine_data,0 AS sale_data,0 AS singleproduct_data FROM bu_product S, bu_mcht_info M WHERE S.mcht_id=M.id AND S.del_flag='0' AND M.del_flag='0' <if test="mchtCode != null and mchtCode != ''">AND M.mcht_code = #{mchtCode}</if><if test="shopName != null and shopName != ''">AND M.shop_name = #{shopName}</if>AND S.create_date <![CDATA[ >= ]]> #{DateBegin} AND S.create_date <![CDATA[ <= ]]> #{DateEnd} GROUP BY each_day
UNION ALL
SELECT DATE_FORMAT(A.create_date,'%Y-%m-%d') AS each_day,0 AS shop_data,COUNT(*) AS examine_data,0 AS sale_data,0 AS singleproduct_data FROM bu_product A, bu_mcht_info P WHERE A.mcht_id=P.id AND A.audit_status='2' AND P.del_flag='0' AND A.del_flag='0' <if test="mchtCode != null and mchtCode != ''">AND P.mcht_code = #{mchtCode}</if><if test="shopName != null and shopName != ''">AND P.shop_name = #{shopName}</if>AND A.create_date <![CDATA[ >= ]]> #{DateBegin} AND A.create_date <![CDATA[ <= ]]> #{DateEnd} GROUP BY each_day
UNION ALL
SELECT DATE_FORMAT(R.create_date,'%Y-%m-%d') AS each_day,0 AS shop_data,0 AS examine_data,COUNT(*) AS sale_data,0 AS singleproduct_data FROM bu_activity_area R, bu_activity B, bu_activity_product T, bu_mcht_info X  WHERE R.id=B.activity_area_id AND T.activity_id=B.id AND R.mcht_id=X.id AND X.del_flag='0' AND T.del_flag='0' AND R.del_flag='0' AND B.del_flag='0' AND T.coo_audit_status='2' AND R.status='1' AND B.status='6' AND B.coo_audit_status='2' <if test="mchtCode != null and mchtCode != ''">AND X.mcht_code = #{mchtCode}</if><if test="shopName != null and shopName != ''">AND X.shop_name = #{shopName}</if>AND R.activity_begin_time &lt;=NOW() AND R.activity_end_time &gt;=NOW() AND R.create_date <![CDATA[ >= ]]> #{DateBegin} AND R.create_date <![CDATA[ <= ]]> #{DateEnd} GROUP BY each_day
UNION ALL
SELECT DATE_FORMAT(T.create_date,'%Y-%m-%d') AS each_day,0 AS shop_data,0 AS examine_data,0 AS sale_data,COUNT(*) AS singleproduct_data FROM bu_single_product_activity T, bu_mcht_info C  WHERE T.mcht_id=C.id AND T.audit_status='3' AND T.is_close='0' AND C.del_flag='0' AND T.del_flag='0' <if test="mchtCode != null and mchtCode != ''">AND C.mcht_code = #{mchtCode}</if><if test="shopName != null and shopName != ''">AND C.shop_name = #{shopName}</if>AND T.begin_time &lt;=NOW() AND T.end_time &gt;=NOW() AND T.create_date <![CDATA[ >= ]]> #{DateBegin} AND T.create_date <![CDATA[ <= ]]> #{DateEnd}  GROUP BY each_day
)T 
GROUP BY t.each_day
  </sql>
  
  <select id="shopcustom" parameterType="java.util.HashMap" resultMap="BaseResultCustomMap">
  	SELECT TAB.* FROM (
		<include refid="selectshopcustom" />
		)TAB
  </select> -->
  
  
  <sql id="selectshopcustom">
  
  SELECT t.each_day,SUM(shop_data) shop_data,SUM(examine_data) examine_data,SUM(sale_data)sale_data,SUM(singleproduct_data) singleproduct_data FROM (
SELECT DATE_FORMAT(S.create_date,'%Y-%m-%d') AS each_day,COUNT(*) AS shop_data, 0 AS examine_data,0 AS sale_data,0 AS singleproduct_data FROM bu_product S, bu_mcht_info M WHERE S.mcht_id=M.id AND S.del_flag='0' AND M.del_flag='0' <if test="mchtCode != null and mchtCode != ''">AND M.mcht_code = #{mchtCode}</if><if test="shopName != null and shopName != ''">AND M.shop_name = #{shopName}</if>AND S.create_date <![CDATA[ >= ]]> #{DateBegin} AND S.create_date <![CDATA[ <= ]]> #{DateEnd} GROUP BY each_day
UNION ALL
SELECT DATE_FORMAT(A.create_date,'%Y-%m-%d') AS each_day,0 AS shop_data,COUNT(*) AS examine_data,0 AS sale_data,0 AS singleproduct_data FROM bu_product A, bu_mcht_info P WHERE A.mcht_id=P.id AND A.audit_status='2' AND P.del_flag='0' AND A.del_flag='0' <if test="mchtCode != null and mchtCode != ''">AND P.mcht_code = #{mchtCode}</if><if test="shopName != null and shopName != ''">AND P.shop_name = #{shopName}</if>AND A.create_date <![CDATA[ >= ]]> #{DateBegin} AND A.create_date <![CDATA[ <= ]]> #{DateEnd} GROUP BY each_day
UNION ALL
SELECT DATE_FORMAT(R.activity_begin_time,'%Y-%m-%d') AS each_day,0 AS shop_data,0 AS examine_data,COUNT(*) AS sale_data,0 AS singleproduct_data FROM bu_activity_area R, bu_mcht_info X  WHERE R.mcht_id=X.id AND X.del_flag='0' AND R.del_flag='0' AND R.source='2' AND R.status='1'<if test="mchtCode != null and mchtCode != ''">AND X.mcht_code = #{mchtCode}</if><if test="shopName != null and shopName != ''">AND X.shop_name = #{shopName}</if> AND R.create_date <![CDATA[ >= ]]> #{DateBegin} AND R.create_date <![CDATA[ <= ]]> #{DateEnd}  AND R.activity_begin_time <![CDATA[ >= ]]> #{DateBegin} AND R.activity_begin_time <![CDATA[ <= ]]> #{DateEnd}GROUP BY each_day
UNION ALL
SELECT DATE_FORMAT(T.begin_time,'%Y-%m-%d') AS each_day,0 AS shop_data,0 AS examine_data,0 AS sale_data,COUNT(*) AS singleproduct_data FROM bu_single_product_activity T, bu_mcht_info C  WHERE T.mcht_id=C.id AND T.audit_status='3' AND T.is_close='0' AND C.del_flag='0' AND T.del_flag='0' <if test="mchtCode != null and mchtCode != ''">AND C.mcht_code = #{mchtCode}</if><if test="shopName != null and shopName != ''">AND C.shop_name = #{shopName}</if>AND T.create_date <![CDATA[ >= ]]> #{DateBegin} AND T.create_date <![CDATA[ <= ]]> #{DateEnd} AND T.begin_time <![CDATA[ >= ]]> #{DateBegin} AND T.begin_time <![CDATA[ <= ]]> #{DateEnd} GROUP BY each_day
)T 
GROUP BY t.each_day
  </sql>
  
  <select id="shopcustom" parameterType="java.util.HashMap" resultMap="BaseResultCustomMap">
  	SELECT TAB.* FROM (
		<include refid="selectshopcustom" />
		)TAB
  </select>
  
  
  <resultMap id="BaseResultCustomNewMap" type="com.jf.entity.ActivityProductCustomNew" extends="com.jf.dao.ActivityProductMapper.BaseResultMap">
    <result column="product_code" property="productCode" jdbcType="VARCHAR" />
    <result column="product_pic" property="productPic" jdbcType="VARCHAR" />
    <result column="product_name" property="productName" jdbcType="VARCHAR" />
    <result column="product_brand_name" property="productBrandName" jdbcType="VARCHAR" />
    <result column="product_art_no" property="productArtNo" jdbcType="VARCHAR"/>
    <result column="sale_price_min" property="salePriceMin" jdbcType="DECIMAL"/>
	<result column="sale_price_Max" property="salePriceMax" jdbcType="DECIMAL"/>
    <result column="discount_min" property="discountMin" jdbcType="DECIMAL"/>
	<result column="discount_max" property="discountMax" jdbcType="DECIMAL"/>
	<result column="product_stock" property="productStock" jdbcType="INTEGER"/>
	<result column="operate_audit_status_desc" property="operateAuditStatusDesc" jdbcType="VARCHAR" />
	<result column="coo_audit_status_desc" property="cooAuditStatusDesc" jdbcType="VARCHAR" />
	<result column="law_audit_status_desc" property="lawAuditStatusDesc" jdbcType="VARCHAR" />
	<result column="operate_audit_name" property="operateAuditName" jdbcType="VARCHAR" />
	<result column="coo_audit_name" property="cooAuditName" jdbcType="VARCHAR" />
	<result column="product_audit_status" property="productAuditStatus" jdbcType="VARCHAR" />
	<result column="product_audit_status_desc" property="productAuditStatusDesc" jdbcType="VARCHAR" />
	<result column="average_sale_price" property="averageSalePrice" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Base_Column_List_custom_new" >
  	id, activity_id, product_id, activity_price, refuse_flag, operate_audit_by, operate_audit_status, 
    design_audit_by, design_audit_status, law_audit_by, law_audit_status, coo_audit_by, 
    coo_audit_status, seq_no, is_watermark, is_gift, create_by, create_date, update_by, 
    update_date, remarks, del_flag,
    (select p.code from bu_product p where p.del_flag = '0' and p.id = ap.product_id) product_code,
    (select pp.pic from bu_product_pic pp where pp.del_flag = '0' and pp.is_default = 1 and pp.product_id = ap.product_id) product_pic,
    (select p.name from bu_product p where p.del_flag = '0' and p.id = ap.product_id) product_name,
    (SELECT pb.name FROM bu_product_brand pb WHERE pb.id = (SELECT p.brand_id FROM bu_product p WHERE p.del_flag = '0' and p.id = ap.product_id)) product_brand_name,
    (select p.art_no from bu_product p where p.del_flag = '0' and p.id = ap.product_id) product_art_no,
    (select min(pi.sale_price) from bu_product_item pi where pi.del_flag='0' and pi.product_id = ap.product_id) sale_price_min,
	(select max(pi.sale_price) from bu_product_item pi where pi.del_flag='0' and pi.product_id = ap.product_id) sale_price_max,
    (select ROUND(min(pi.sale_price/pi.tag_price)*10,2) from bu_product_item pi where pi.del_flag = '0' and pi.product_id = ap.product_id) discount_min,
	(select ROUND(max(pi.sale_price/pi.tag_price)*10,2) from bu_product_item pi where pi.del_flag = '0' and pi.product_id = ap.product_id) discount_max,
    (select IFNULL(SUM(pi.stock-pi.locked_amount),0) from bu_product_item pi where pi.del_flag = '0' and pi.product_id = ap.product_id) product_stock,
    FUN_GET_STATUS_DESC("BU_ACTIVITY_PRODUCT","OPERATE_AUDIT_STATUS", ap.operate_audit_status) operate_audit_status_desc,
    FUN_GET_STATUS_DESC("BU_ACTIVITY_PRODUCT","COO_AUDIT_STATUS", ap.coo_audit_status) coo_audit_status_desc,
    FUN_GET_STATUS_DESC("BU_ACTIVITY_PRODUCT","LAW_AUDIT_STATUS", ap.law_audit_status) law_audit_status_desc,
    (select ssi.staff_name from sys_staff_info ssi where ssi.staff_id = ap.operate_audit_by) operate_audit_name,
    (select ssi.staff_name from sys_staff_info ssi where ssi.staff_id = ap.coo_audit_by) coo_audit_name,
    (select p.audit_status from bu_product p where p.del_flag = '0' and p.id = ap.product_id) product_audit_status,
    FUN_GET_STATUS_DESC("BU_PRODUCT","AUDIT_STATUS", (select p.audit_status from bu_product p where p.del_flag = '0' and p.id = ap.product_id)) product_audit_status_desc,  
    <![CDATA[
  		(select TRUNCATE(IFNULL((SUM(od.sale_price)-SUM(od.mcht_preferential)), 0)/COUNT(0), 2) from bu_order_dtl od where od.del_flag = '0' and od.product_id = ap.product_id) average_sale_price
  	]]>
  </sql>
  <select id="selectByCustomNewExample" resultMap="BaseResultCustomNewMap" parameterType="com.jf.entity.ActivityProductCustomExample" >
    select
    <if test="distinct" >
      distinct
    </if>
    <include refid="Base_Column_List_custom_new" />
    from bu_activity_product ap
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null" >
      order by ${orderByClause}
    </if>
    <if test="limitStart != null and limitStart>=0" >
      limit #{limitStart} , #{limitSize}
    </if>
  </select>
  
  
  <!-- 取同商家同品牌同货号商品中历史静态活动价的最低值（不包含当前静态活动价） -->
  <resultMap id="BaseResultCustomNewMapTwo" type="com.jf.entity.ActivityProductCustomNew" extends="com.jf.dao.ActivityProductCustomMapper.BaseResultCustomNewMap">
  	<result column="activity_price_min" property="activityPriceMin" jdbcType="DECIMAL" />
  	<result column="deposit" property="deposit" jdbcType="DECIMAL" />
  	<result column="deduct_amount" property="deductAmount" jdbcType="DECIMAL" />
  	<result column="product_svip_discount" property="productSvipDiscount" jdbcType="DECIMAL" />
  	<result column="favorable_rate" property="favorableRate" jdbcType="DECIMAL" />
  	<result column="sales_volume" property="salesVolume" jdbcType="INTEGER" />
  	<result column="mall_price_min" property="mallPriceMin" jdbcType="DECIMAL"/>
	<result column="mall_price_max" property="mallPriceMax" jdbcType="DECIMAL"/>
    <result column="sale_price" property="salePrice" jdbcType="DECIMAL" />
    <result column="mcht_type" property="mchtType" jdbcType="CHAR" />
  	<result column="cost_price" property="costPrice" jdbcType="DECIMAL" />
  	<result column="cost_price_min" property="costPriceMin" jdbcType="DECIMAL"/>
	<result column="cost_price_max" property="costPriceMax" jdbcType="DECIMAL"/>
  </resultMap>
  <sql id="Base_Column_List_custom_new_two" >
  	ap.*,
    bp.code product_code,
    bp.name product_name,
    bp.art_no product_art_no,
    bp.audit_status product_audit_status,
    bp.svip_discount product_svip_discount,
    (select pp.pic from bu_product_pic pp where pp.del_flag = '0' and pp.is_default = 1 and pp.product_id = ap.product_id) product_pic,
    (SELECT pb.name FROM bu_product_brand pb WHERE pb.id = (SELECT p.brand_id FROM bu_product p WHERE p.del_flag = '0' and p.id = ap.product_id)) product_brand_name,
    (select min(pi.sale_price) from bu_product_item pi where pi.del_flag='0' and pi.product_id = ap.product_id) sale_price_min,
	(select max(pi.sale_price) from bu_product_item pi where pi.del_flag='0' and pi.product_id = ap.product_id) sale_price_max,
	(select min(pi.mall_price) from bu_product_item pi where pi.del_flag='0' and pi.product_id = ap.product_id) mall_price_min,
	(select max(pi.mall_price) from bu_product_item pi where pi.del_flag='0' and pi.product_id = ap.product_id) mall_price_max,
    (select ROUND(min(pi.sale_price/pi.tag_price)*10,2) from bu_product_item pi where pi.del_flag = '0' and pi.product_id = ap.product_id) discount_min,
	(select ROUND(max(pi.sale_price/pi.tag_price)*10,2) from bu_product_item pi where pi.del_flag = '0' and pi.product_id = ap.product_id) discount_max,
    (select IFNULL(SUM(pi.stock-pi.locked_amount),0) from bu_product_item pi where pi.del_flag = '0' and pi.product_id = ap.product_id) product_stock,
    FUN_GET_STATUS_DESC("BU_ACTIVITY_PRODUCT","OPERATE_AUDIT_STATUS", ap.operate_audit_status) operate_audit_status_desc,
    FUN_GET_STATUS_DESC("BU_ACTIVITY_PRODUCT","COO_AUDIT_STATUS", ap.coo_audit_status) coo_audit_status_desc,
    FUN_GET_STATUS_DESC("BU_ACTIVITY_PRODUCT","LAW_AUDIT_STATUS", ap.law_audit_status) law_audit_status_desc,
    (select ssi.staff_name from sys_staff_info ssi where ssi.staff_id = ap.operate_audit_by) operate_audit_name,
    (select ssi.staff_name from sys_staff_info ssi where ssi.staff_id = ap.coo_audit_by) coo_audit_name,
    FUN_GET_STATUS_DESC("BU_PRODUCT","AUDIT_STATUS", (select p.audit_status from bu_product p where p.del_flag = '0' and p.id = ap.product_id)) product_audit_status_desc,  
    <![CDATA[
  		(select TRUNCATE(IFNULL((SUM(od.sale_price)-SUM(od.mcht_preferential)), 0)/COUNT(0), 2) from bu_order_dtl od where od.del_flag = '0' and od.product_id = ap.product_id) average_sale_price,
  	]]>
  	(select min(bap.activity_price) from bu_activity_product bap, bu_product p where bap.del_flag = '0' and p.del_flag = '0' and bap.product_id = p.id and bap.id != ap.id and p.mcht_id = bp.mcht_id and p.brand_id = bp.brand_id and p.art_no = bp.art_no ) activity_price_min,
  	(select apd.deposit from bu_activity_product_deposit apd where apd.activity_id = ap.activity_id and apd.product_id = ap.product_id and apd.del_flag='0')deposit,
  	(select apd.deduct_amount from bu_activity_product_deposit apd where apd.activity_id = ap.activity_id and apd.product_id = ap.product_id and apd.del_flag='0')deduct_amount,
  	((select count(c.id) from bu_comment c where c.del_flag='0' and c.product_id=bp.id and c.product_score in(4,5))/(select count(c.id) from bu_comment c where c.del_flag='0' and c.product_id=bp.id)) favorable_rate,
	(select sum(od.quantity) from bu_order_dtl od where od.product_id=bp.id and od.product_status='1' and od.del_flag='0') sales_volume,
  	(<![CDATA[
  	select 
				bpi.sale_price 
			from 
				bu_activity_product ap,bu_activity a,bu_activity_area aa,bu_product_item bpi 
			where 
  	ap.product_id = bp.id and ap.activity_id = a.id and a.activity_area_id = aa.id and ap.product_id = bpi.product_id
	and bpi.id = bp.min_sale_price_item_id and ap.del_flag='0' and a.del_flag='0' and aa.del_flag='0' and bpi.del_flag='0'
	and aa.status = '1' and aa.activity_begin_time<=now() and aa.activity_end_time>=now() and a.status = '6' 
	and ap.coo_audit_status = '2' and ap.refuse_flag = 0]]>) sale_price,
	(select mi.mcht_type from bu_mcht_info mi where bp.mcht_id=mi.id and mi.del_flag='0')mcht_type,
  	(select pi.cost_price from bu_product_item pi where pi.del_flag='0' and pi.product_id = ap.product_id LIMIT 1)cost_price,
  	(select min(pi.cost_price) from bu_product_item pi where pi.del_flag='0' and pi.product_id = ap.product_id) cost_price_min,
	(select max(pi.cost_price) from bu_product_item pi where pi.del_flag='0' and pi.product_id = ap.product_id) cost_price_max,
	(select max(pi.tag_price) from bu_product_item pi where pi.del_flag='0' and pi.product_id = ap.product_id) tag_price_max,
    (select min(pi.tag_price) from bu_product_item pi where pi.del_flag='0' and pi.product_id = ap.product_id) tag_price_min,
    (select bp.svip_discount from bu_product bp where ap.product_id = bp.id and bp.del_flag = '0' limit 1 ) svipDiscount,
    (select IFNULL(bmpb.pop_commission_rate, 0)  from bu_mcht_product_brand  bmpb , bu_product_brand  bpb  where bmpb.mcht_id = bp.mcht_id and  bmpb.product_brand_id= bp.brand_id  and bmpb.product_brand_id =bpb.id and bmpb.del_flag='0' and bp.del_flag='0' AND bmpb.audit_status='3' AND bmpb.status='1' and bpb.status='1' and  bpb.del_flag='0' ) popCommissionRate
  </sql>
  <select id="selectActivityProductCustomNewExample" resultMap="BaseResultCustomNewMapTwo" parameterType="com.jf.entity.ActivityProductCustomExample" >
    select
    <if test="distinct" >
      distinct
    </if>
    <include refid="Base_Column_List_custom_new_two" />
    from bu_activity_product ap, bu_product bp
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null" >
      order by ${orderByClause}
    </if>
    <if test="limitStart != null and limitStart>=0" >
      limit #{limitStart} , #{limitSize}
    </if>
  </select>
  <select id="countActivityProductCustomNewExample" parameterType="com.jf.entity.ActivityProductCustomExample" resultType="java.lang.Integer" >
    select count(*) from bu_activity_product ap, bu_product bp
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  
  
  
  <update id="updateActivityProductIdListSelective" parameterType="java.util.List" >
    <foreach collection="list" item="record" index="index" open="" close="" separator=";" >
	    update bu_activity_product
	    <set >
	      <if test="record.id != null" >
	        id = #{record.id,jdbcType=INTEGER},
	      </if>
	      <if test="record.activityId != null" >
	        activity_id = #{record.activityId,jdbcType=INTEGER},
	      </if>
	      <if test="record.productId != null" >
	        product_id = #{record.productId,jdbcType=INTEGER},
	      </if>
	      <if test="record.activityPrice != null" >
	        activity_price = #{record.activityPrice,jdbcType=DECIMAL},
	      </if>
	      <if test="record.refuseFlag != null" >
	        refuse_flag = #{record.refuseFlag,jdbcType=CHAR},
	      </if>
	      <if test="record.operateAuditBy != null" >
	        operate_audit_by = #{record.operateAuditBy,jdbcType=INTEGER},
	      </if>
	      <if test="record.operateAuditStatus != null" >
	        operate_audit_status = #{record.operateAuditStatus,jdbcType=CHAR},
	      </if>
	      <if test="record.designAuditBy != null" >
	        design_audit_by = #{record.designAuditBy,jdbcType=INTEGER},
	      </if>
	      <if test="record.designAuditStatus != null" >
	        design_audit_status = #{record.designAuditStatus,jdbcType=CHAR},
	      </if>
	      <if test="record.lawAuditBy != null" >
	        law_audit_by = #{record.lawAuditBy,jdbcType=INTEGER},
	      </if>
	      <if test="record.lawAuditStatus != null" >
	        law_audit_status = #{record.lawAuditStatus,jdbcType=CHAR},
	      </if>
	      <if test="record.cooAuditBy != null" >
	        coo_audit_by = #{record.cooAuditBy,jdbcType=INTEGER},
	      </if>
	      <if test="record.cooAuditStatus != null" >
	        coo_audit_status = #{record.cooAuditStatus,jdbcType=CHAR},
	      </if>
	      <if test="record.seqNo != null" >
	        seq_no = #{record.seqNo,jdbcType=INTEGER},
	      </if>
	      <if test="record.isWatermark != null" >
	        is_watermark = #{record.isWatermark,jdbcType=CHAR},
	      </if>
	      <if test="record.createBy != null" >
	        create_by = #{record.createBy,jdbcType=INTEGER},
	      </if>
	      <if test="record.createDate != null" >
	        create_date = #{record.createDate,jdbcType=TIMESTAMP},
	      </if>
	      <if test="record.updateBy != null" >
	        update_by = #{record.updateBy,jdbcType=INTEGER},
	      </if>
	      <if test="record.updateDate != null" >
	        update_date = #{record.updateDate,jdbcType=TIMESTAMP},
	      </if>
	      <if test="record.remarks != null" >
	        remarks = #{record.remarks,jdbcType=VARCHAR},
	      </if>
	      <if test="record.delFlag != null" >
	        del_flag = #{record.delFlag,jdbcType=CHAR},
	      </if>
	    </set>
	    where id = #{record.id,jdbcType=INTEGER}
    </foreach>
  </update>
  
  
</mapper>